<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sensor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { padding: 20px; background: #f5f7fa; }
    .sensor-card { border-radius: 12px; padding: 20px; margin: 10px; background: white; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    .sensor-value { font-size: 2em; font-weight: bold; }
  </style>
</head>
<body>
  <h1 class="mb-4">🌐 WebUSB Sensor Dashboard</h1>
  <button id="connect" class="btn btn-primary mb-3">🔌 Connect Device</button>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="sensorTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">Dashboard</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">History</button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <!-- Dashboard -->
    <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
      <div class="row">
        <div class="col-md-4 sensor-card">🌡️ Temp: <div id="tempVal" class="sensor-value">-- °C</div></div>
        <div class="col-md-4 sensor-card">💧 Humidity: <div id="humVal" class="sensor-value">-- %</div></div>
        <div class="col-md-4 sensor-card">🔋 Battery: <div id="batVal" class="sensor-value">-- V</div></div>
        <div class="col-md-4 sensor-card">🕺 Motion: <div id="motionVal" class="sensor-value">--</div></div>
        <div class="col-md-4 sensor-card">💡 Light: <div id="lightVal" class="sensor-value">-- lux</div></div>
      </div>
      <div id="extraTabs"></div>
    </div>

    <!-- History -->
    <div class="tab-pane fade" id="history" role="tabpanel">
      <canvas id="historyChart" height="100"></canvas>
    </div>
  </div>

  <script>
    let device;
    let chart;
    let historyData = { labels: [], temp: [], hum: [] };

    // 🔹 Keep track of endpoints
    let inEndpoint = null;
    let outEndpoint = null;

    async function connectDevice() {
      try {
        device = await navigator.usb.requestDevice({
          filters: [{ vendorId: 0x2FE3 }] // Nordic VID
        });
        await device.open();
        await device.selectConfiguration(1);
        await device.claimInterface(0);

        // 🔹 Find endpoints
        const iface = device.configuration.interfaces[0].alternates[0];
        for (const ep of iface.endpoints) {
          if (ep.direction === "in") inEndpoint = ep.endpointNumber;
          if (ep.direction === "out") outEndpoint = ep.endpointNumber;
        }

        console.log("Connected:", device.productName);
        console.log("Endpoints -> IN:", inEndpoint, " OUT:", outEndpoint);

        readLoop(); // 🔹 start reading from device
      } catch (err) {
        console.error("USB Error:", err);
      }
    }

    async function readLoop() {
      while (device && device.opened) {
        try {
          const result = await device.transferIn(inEndpoint, 64); // 64 bytes at a time
          if (result.data && result.data.byteLength > 0) {
            const text = new TextDecoder().decode(result.data);
            console.log("RX:", text);

            // 🔹 Expect JSON packets from firmware
            try {
              const packet = JSON.parse(text);
              updateDashboard(packet);
            } catch (e) {
              console.warn("Non-JSON or partial packet:", text);
            }
          }
        } catch (err) {
          console.error("Read error:", err);
          break;
        }
      }
    }

    function updateDashboard(packet) {
      const core = packet.core || packet;

      // Core sensors
      document.getElementById("tempVal").innerText = core.temp + " °C";
      document.getElementById("humVal").innerText = core.hum + " %";
      document.getElementById("batVal").innerText = core.batt + " V";
      document.getElementById("motionVal").innerText = core.motion ? "Yes" : "No";
      document.getElementById("lightVal").innerText = core.light + " lux";

      // Dynamic sensor tabs
      const extraTabs = document.getElementById("extraTabs");
      extraTabs.innerHTML = ""; // clear and rebuild
      if (packet.extra) {
        packet.extra.forEach(sensor => {
          const div = document.createElement("div");
          div.className = "sensor-card";
          div.innerHTML = `
            <h5>🔎 Sensor ${sensor.id}</h5>
            <p>Type: ${sensor.type}</p>
            <p>RSSI: ${sensor.rssi} dBm</p>
            <p>Last Seen: ${new Date(sensor.last_seen).toLocaleTimeString()}</p>
            <p>Values: ${JSON.stringify(sensor.values)}</p>
          `;
          extraTabs.appendChild(div);
        });
      }

      // History chart
      historyData.labels.push(new Date().toLocaleTimeString());
      historyData.temp.push(core.temp);
      historyData.hum.push(core.hum);
      if (chart) chart.update();
    }

    function setupHistoryChart() {
      const ctx = document.getElementById("historyChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: historyData.labels,
          datasets: [
            { label: "Temp (°C)", data: historyData.temp, borderColor: "red" },
            { label: "Humidity (%)", data: historyData.hum, borderColor: "blue" }
          ]
        },
        options: { responsive: true }
      });
    }

    document.getElementById("connect").onclick = () => {
      connectDevice();
      setupHistoryChart();
    };
  </script>
</body>
</html>
