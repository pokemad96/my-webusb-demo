<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sensor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { padding: 20px; background: #f5f7fa; }
    .sensor-card { border-radius: 12px; padding: 20px; margin: 10px; background: white; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    .sensor-value { font-size: 2em; font-weight: bold; }
  </style>
</head>
<body>
  <h1 class="mb-4">🌐 WebUSB Sensor Dashboard</h1>
  <button id="connect" class="btn btn-primary mb-3">🔌 Connect Device</button>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="sensorTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">Dashboard</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">History</button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <!-- Dashboard -->
    <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
      <div class="row">
        <div class="col-md-4 sensor-card">🌡️ Temp: <div id="tempVal" class="sensor-value">-- °C</div></div>
        <div class="col-md-4 sensor-card">💧 Humidity: <div id="humVal" class="sensor-value">-- %</div></div>
        <div class="col-md-4 sensor-card">🔋 Battery: <div id="batVal" class="sensor-value">-- V</div></div>
        <div class="col-md-4 sensor-card">🕺 Motion: <div id="motionVal" class="sensor-value">--</div></div>
        <div class="col-md-4 sensor-card">💡 Light: <div id="lightVal" class="sensor-value">-- lux</div></div>
      </div>
      <div id="extraTabs"></div>
    </div>

    <!-- History -->
    <div class="tab-pane fade" id="history" role="tabpanel">
      <canvas id="historyChart" height="100"></canvas>
    </div>
  </div>

  <script>
    let device;
    let chart;
    let historyData = { labels: [], temp: [], hum: [] };

    async function connectDevice() {
      try {
        device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x1915 }] }); // Nordic VID
        await device.open();
        await device.selectConfiguration(1);
        await device.claimInterface(0);
        console.log("Connected:", device.productName);
        // TODO: Start polling or listening for reports from the device
      } catch (err) {
        console.error("USB Error:", err);
      }
    }

    function updateDashboard(values) {
      document.getElementById("tempVal").innerText = values.temp + " °C";
      document.getElementById("humVal").innerText = values.hum + " %";
      document.getElementById("batVal").innerText = values.batt + " V";
      document.getElementById("motionVal").innerText = values.motion ? "Yes" : "No";
      document.getElementById("lightVal").innerText = values.light + " lux";

      // Update history
      historyData.labels.push(new Date().toLocaleTimeString());
      historyData.temp.push(values.temp);
      historyData.hum.push(values.hum);
      if (chart) chart.update();
    }

    function setupHistoryChart() {
      const ctx = document.getElementById("historyChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: historyData.labels,
          datasets: [
            { label: "Temp (°C)", data: historyData.temp, borderColor: "red" },
            { label: "Humidity (%)", data: historyData.hum, borderColor: "blue" }
          ]
        },
        options: { responsive: true }
      });
    }

    document.getElementById("connect").onclick = () => {
      connectDevice();
      setupHistoryChart();
      // For demo: simulate updates
      setInterval(() => {
        updateDashboard({
          temp: (20 + Math.random()*5).toFixed(1),
          hum: (50 + Math.random()*10).toFixed(1),
          batt: (3.7 + Math.random()*0.1).toFixed(2),
          motion: Math.random() > 0.5,
          light: (100 + Math.random()*50).toFixed(0)
        });
      }, 2000);
    };
  </script>
</body>
</html>
