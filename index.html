<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sensor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { padding: 20px; background: #f5f7fa; }
    .sensor-card { border-radius: 12px; padding: 20px; margin: 10px; background: white; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    .sensor-value { font-size: 2em; font-weight: bold; }
  </style>
</head>
<body>
  <h1 class="mb-4">ğŸŒ WebUSB Sensor Dashboard</h1>
  <button id="connect" class="btn btn-primary mb-3">ğŸ”Œ Connect Device</button>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="sensorTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">Dashboard</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">History</button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <!-- Dashboard -->
    <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
      <div class="row">
        <div class="col-md-4 sensor-card">ğŸŒ¡ï¸ Temp: <div id="tempVal" class="sensor-value">-- Â°C</div></div>
        <div class="col-md-4 sensor-card">ğŸ’§ Humidity: <div id="humVal" class="sensor-value">-- %</div></div>
        <div class="col-md-4 sensor-card">ğŸ”‹ Battery: <div id="batVal" class="sensor-value">-- V</div></div>
        <div class="col-md-4 sensor-card">ğŸ•º Motion: <div id="motionVal" class="sensor-value">--</div></div>
        <div class="col-md-4 sensor-card">ğŸ’¡ Light: <div id="lightVal" class="sensor-value">-- lux</div></div>
      </div>
      <div id="extraTabs"></div>
    </div>

    <!-- History -->
    <div class="tab-pane fade" id="history" role="tabpanel">
      <canvas id="historyChart" height="100"></canvas>
    </div>
  </div>
<script>
  var serial = {};

(function() {
  'use strict';

  serial.getPorts = function() {
    return navigator.usb.getDevices().then(devices => {
      return devices.map(device => new serial.Port(device));
    });
  };

  serial.requestPort = function() {
    const filters = [
      { 'vendorId': 0x2fe3, 'productId': 0x0100 },
      { 'vendorId': 0x2fe3, 'productId': 0x00a },
      { 'vendorId': 0x8086, 'productId': 0xF8A1 },
    ];
    return navigator.usb.requestDevice({ 'filters': filters }).then(
      device => new serial.Port(device)
    );
  }

  serial.Port = function(device) {
    this.device_ = device;
  };

  serial.Port.prototype.connect = function() {
      let buffer = "";  // holds incomplete message parts

  const readLoop = () => {
    const { endpointNumber } =
      this.device_.configuration.interfaces[0].alternate.endpoints[0];

    this.device_.transferIn(endpointNumber, 64).then(result => {
      const text = new TextDecoder().decode(result.data);

      // Append to buffer
      buffer += text;

      try {
        // Try to parse full JSON objects out of the buffer
        // We assume each JSON object ends with '\n'
        let newlineIndex;
        while ((newlineIndex = buffer.indexOf("\n")) >= 0) {
          const jsonStr = buffer.slice(0, newlineIndex).trim();
          buffer = buffer.slice(newlineIndex + 1);
    
          if (jsonStr.length > 0) {
            this.onReceive(jsonStr);
            // try {
            //   const packet = JSON.parse(jsonStr);
            //   this.onReceive(packet);   // parsed object
            // } catch (e) {
            //   console.warn("Invalid JSON chunk:", jsonStr);
            // }
          }
        }
      } catch (e) {
        console.error("Parse error:", e);
      }

      readLoop(); // keep going
    }, error => {
      this.onReceiveError(error);
    });
  };

    return this.device_.open()
        .then(() => {
          if (this.device_.configuration === null) {
            return this.device_.selectConfiguration(1);
          }
        })
        .then(() => this.device_.claimInterface(0))
        .then(() => {
          readLoop();
        });
  };

  serial.Port.prototype.disconnect = function() {
    return this.device_.close();
  };

  serial.Port.prototype.send = function(data) {
    const {
      endpointNumber
    } = this.device_.configuration.interfaces[0].alternate.endpoints[1]
    return this.device_.transferOut(endpointNumber, data);
  };
})();

let port;

function connect() {
  port.connect().then(() => {
    port.onReceive = data => {
      let textDecoder = new TextDecoder();
      let text = textDecoder.decode(data);
      console.log("Received:", text);
      // ğŸ”¹ Expect JSON packets from firmware
      try {
        const packet = JSON.parse(text);
        updateDashboard(packet);
      } catch (e) {
        console.warn("Non-JSON or partial packet:", text);
      }
    }
    port.onReceiveError = error => {
      console.error(error);
      document.querySelector("#connect").style = "visibility: initial";
      port.disconnect();
    };
  });
}

function send(string) {
  console.log("sending to serial:" + string.length);
  if (string.length === 0)
    return;
  console.log("sending to serial: [" + string +"]\n");

  let view = new TextEncoder('utf-8').encode(string);
  console.log(view);
  if (port) {
    port.send(view);
  }
};

window.onload = _ => {
  document.querySelector("#connect").onclick = function() {
    serial.requestPort().then(selectedPort => {
      port = selectedPort;
      this.style = "visibility: hidden";
      connect();
    });
  }

  document.querySelector("#submit").onclick = () => {
    let source = document.querySelector("#input").value;
    send(source);
  }
  }

    function updateDashboard(packet) {
      const core = packet.core || packet;

      // Core sensors
      document.getElementById("tempVal").innerText = core.temp + " Â°C";
      document.getElementById("humVal").innerText = core.hum + " %";
      document.getElementById("batVal").innerText = core.batt + " V";
      document.getElementById("motionVal").innerText = core.motion ? "Yes" : "No";
      document.getElementById("lightVal").innerText = core.light + " lux";

      // Dynamic sensor tabs
      const extraTabs = document.getElementById("extraTabs");
      extraTabs.innerHTML = ""; // clear and rebuild
      if (packet.extra) {
        packet.extra.forEach(sensor => {
          const div = document.createElement("div");
          div.className = "sensor-card";
          div.innerHTML = `
            <h5>ğŸ” Sensor ${sensor.id}</h5>
            <p>Type: ${sensor.type}</p>
            <p>RSSI: ${sensor.rssi} dBm</p>
            <p>Last Seen: ${new Date(sensor.last_seen).toLocaleTimeString()}</p>
            <p>Values: ${JSON.stringify(sensor.values)}</p>
          `;
          extraTabs.appendChild(div);
        });
      }

      // History chart
      historyData.labels.push(new Date().toLocaleTimeString());
      historyData.temp.push(core.temp);
      historyData.hum.push(core.hum);
      if (chart) chart.update();
    }

    function setupHistoryChart() {
      const ctx = document.getElementById("historyChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: historyData.labels,
          datasets: [
            { label: "Temp (Â°C)", data: historyData.temp, borderColor: "red" },
            { label: "Humidity (%)", data: historyData.hum, borderColor: "blue" }
          ]
        },
        options: { responsive: true }
      });
    }

    document.getElementById("connect").onclick = () => {
      connectDevice();
      setupHistoryChart();
    };
  </script>
</body>
</html>
